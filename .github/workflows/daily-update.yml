name: Daily NBA SIM Update

on:
  schedule:
    # ── POST-GAME: 11:30 PM PST = 7:30 AM UTC ──
    # Settle blog + load tomorrow's slate (BM fallback if RotoWire stale)
    - cron: '30 7 * * *'

    # ── EARLY AM: 5:00 AM PST = 1:00 PM UTC ──
    # Overnight refresh — BM fallback or RotoWire with confirmed lineups
    - cron: '0 13 * * *'

    # ── PRE-GAME: 9:30 AM PST = 5:30 PM UTC ──
    # Final pre-tip update — RotoWire confirmed lineups + fresh DSI
    - cron: '30 17 * * *'

    # ── POST-GAME SETTLEMENT: 9:00 AM PST = 5:00 PM UTC ──
    # Grades yesterday's picks, updates bankroll + blog
    - cron: '0 17 * * *'

  workflow_dispatch:
    inputs:
      full_pipeline:
        description: 'Run full pipeline (collect + analyze + scores + predict)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      settle_only:
        description: 'Run settlement only (grade picks + update blog)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: write

jobs:
  # ════════════════════════════════════════════
  # PRE-GAME JOBS (evening cron + manual)
  # ════════════════════════════════════════════

  update-lines:
    # Skip on morning settlement cron (5 PM UTC = 9 AM PST)
    if: github.event.schedule != '0 17 * * *' && inputs.settle_only != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout nbasim
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Create .env
        run: echo "ODDS_API_KEY=${{ secrets.ODDS_API_KEY }}" > .env

      # ── Optional: full pipeline (manual trigger only) ──
      - name: Run full pipeline
        if: inputs.full_pipeline == 'true'
        timeout-minutes: 20
        run: |
          echo "=== Full pipeline: collect (skip-boxscores) → analyze → scores → predict ==="
          python main.py collect --skip-boxscores 2>&1 | tail -30
          python main.py analyze 2>&1 | tail -10
          python main.py scores 2>&1 | tail -10
          python main.py predict 2>&1 | tail -10
          echo "=== Full pipeline complete ==="

      # ── Always: pull fresh odds + generate HTML ──
      - name: Generate dashboard (fresh odds + props)
        run: python generate_frontend.py

      # ── Commit + push ──
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          DATE=$(TZ='America/Los_Angeles' date '+%b %d %I:%M %p PST')

          git add index.html nba_sim.html

          # Include DB if full pipeline ran
          if [ "${{ inputs.full_pipeline }}" = "true" ]; then
            git add db/nba_sim.db
          fi

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Auto-update lines — ${DATE}"
          git push

  # ── Sync to MORELLOSIMS (blog + nbasim dashboard) ──
  sync-to-morellosims:
    needs: update-lines
    if: github.event.schedule != '0 17 * * *' && inputs.settle_only != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout MORELLOSIMS
        uses: actions/checkout@v4
        with:
          repository: jack-more/MORELLOSIMS
          token: ${{ secrets.MORELLOSIMS_PAT }}
          path: morellosims

      - name: Checkout nbasim (fresh HTML)
        uses: actions/checkout@v4
        with:
          path: nbasim

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install deps
        run: pip install beautifulsoup4

      - name: Sync pick data to blog
        run: python nbasim/scripts/update_blog.py nbasim/index.html morellosims/index.html

      - name: Copy NBA SIM dashboard + inject auth
        run: |
          cp nbasim/index.html morellosims/nbasim/index.html
          FILE=morellosims/nbasim/index.html

          # Inject auth CSS before </head>
          sed -i 's|</head>|    <link rel="stylesheet" href="../morello-auth.css">\n</head>|' "$FILE"

          # Add dark theme attribute to body
          sed -i 's|<body>|<body data-ma-theme="dark">|' "$FILE"

          # Add status-indicators div for profile button
          sed -i 's|<div class="top-picks">|<div class="top-picks" style="display:flex;align-items:center;gap:8px;">\n                <div class="status-indicators" style="display:flex;align-items:center;"></div>|' "$FILE"

          # Inject Firebase SDK + auth JS before </body>
          sed -i 's|</body>|\n    <!-- Firebase SDK + Morello Auth -->\n    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>\n    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>\n    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>\n    <script src="../morello-auth.js"></script>\n</body>|' "$FILE"

      - name: Commit and push
        working-directory: morellosims
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          DATE=$(TZ='America/Los_Angeles' date '+%b %d %I:%M %p PST')

          git add index.html nbasim/index.html

          if git diff --cached --quiet; then
            echo "No changes"
            exit 0
          fi

          git commit -m "Auto-sync lines from NBA SIM — ${DATE}"
          git push

  # ════════════════════════════════════════════
  # POST-GAME SETTLEMENT JOBS (morning cron + manual)
  # ════════════════════════════════════════════

  grade-picks:
    # Run on morning settlement cron or manual settle_only trigger
    if: github.event.schedule == '0 17 * * *' || inputs.settle_only == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout nbasim
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Create .env
        run: echo "ODDS_API_KEY=${{ secrets.ODDS_API_KEY }}" > .env

      - name: Grade picks
        run: python scripts/grade_picks.py

      - name: Commit settlement results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          DATE=$(TZ='America/Los_Angeles' date '+%b %d %I:%M %p PST')

          git add data/settlement_results.json db/nba_sim.db

          if git diff --cached --quiet; then
            echo "No settlement changes"
            exit 0
          fi

          git commit -m "Grade picks — ${DATE}"
          git push

  settle-morellosims:
    needs: grade-picks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout MORELLOSIMS
        uses: actions/checkout@v4
        with:
          repository: jack-more/MORELLOSIMS
          token: ${{ secrets.MORELLOSIMS_PAT }}
          path: morellosims

      - name: Checkout nbasim (with settlement results)
        uses: actions/checkout@v4
        with:
          path: nbasim

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Settle blog with results
        run: python nbasim/scripts/settle_blog.py nbasim/data/settlement_results.json morellosims/index.html

      - name: Copy NBA SIM dashboard + inject auth
        run: |
          cp nbasim/index.html morellosims/nbasim/index.html
          FILE=morellosims/nbasim/index.html

          # Inject auth CSS before </head>
          sed -i 's|</head>|    <link rel="stylesheet" href="../morello-auth.css">\n</head>|' "$FILE"

          # Add dark theme attribute to body
          sed -i 's|<body>|<body data-ma-theme="dark">|' "$FILE"

          # Add status-indicators div for profile button
          sed -i 's|<div class="top-picks">|<div class="top-picks" style="display:flex;align-items:center;gap:8px;">\n                <div class="status-indicators" style="display:flex;align-items:center;"></div>|' "$FILE"

          # Inject Firebase SDK + auth JS before </body>
          sed -i 's|</body>|\n    <!-- Firebase SDK + Morello Auth -->\n    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>\n    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>\n    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>\n    <script src="../morello-auth.js"></script>\n</body>|' "$FILE"

      - name: Commit and push
        working-directory: morellosims
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          DATE=$(TZ='America/Los_Angeles' date '+%b %d %I:%M %p PST')

          git add index.html nbasim/index.html

          if git diff --cached --quiet; then
            echo "No settlement blog changes"
            exit 0
          fi

          git commit -m "Settle picks — ${DATE}"
          git push
